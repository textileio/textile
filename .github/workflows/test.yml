name: Test
on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
jobs:
  api:
    name: API
    runs-on: ubuntu-latest
    steps:
      - name: setup
        uses: actions/setup-go@v1
        with:
          go-version: 1.15
      - name: checkout
        if: success()
        uses: actions/checkout@v1
        with:
          ref: master
      - name: checkout-master
        if: success()
        run: git checkout master
      - name: checkout
        if: success()
        uses: actions/checkout@v1
      - name: test
        env:
          STRIPE_API_KEY: ${{ secrets.STRIPE_API_KEY }}
        run: go test -v -timeout 45m -race -p 1 ./api/... ./mongodb/...
  buckets:
    name: Buckets
    runs-on: ubuntu-latest
    steps:
      - name: setup
        uses: actions/setup-go@v1
        with:
          go-version: 1.15
      - name: checkout
        if: success()
        uses: actions/checkout@v1
        with:
          ref: master
      - name: checkout-master
        if: success()
        run: git checkout master
      - name: checkout
        if: success()
        uses: actions/checkout@v1
      - name: test
        run: go test -v -timeout 45m -race -p 1 ./buckets/...
  archives:
    name: Archives
    runs-on: self-hosted
    steps:
      - name: setup
        uses: actions/setup-go@v1
        with:
          go-version: 1.15
      - name: checkout
        if: success()
        uses: actions/checkout@v1
        with:
          ref: master
      - name: checkout-master
        if: success()
        run: git checkout master
      - name: checkout
        if: success()
        uses: actions/checkout@v1
      - name: test
        run: go test -v -timeout 45m -race -p 1 ./integrationtest/...
  mail:
    name: Mail
    runs-on: ubuntu-latest
    steps:
      - name: setup
        uses: actions/setup-go@v1
        with:
          go-version: 1.15
      - name: checkout
        if: success()
        uses: actions/checkout@v1
        with:
          ref: master
      - name: checkout-master
        if: success()
        run: git checkout master
      - name: checkout
        if: success()
        uses: actions/checkout@v1
      - name: test
        run: go test -v -timeout 45m -race -p 1 ./mail/...