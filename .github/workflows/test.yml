name: Test
on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
jobs:
  hub-api:
    name: Hub API
    runs-on: ubuntu-latest
    steps:
      - name: setup
        uses: actions/setup-go@v1
        with:
          go-version: 1.15
      - name: checkout
        uses: actions/checkout@v1
      - name: test
        env:
          STRIPE_API_KEY: ${{ secrets.STRIPE_API_KEY }}
        run: go test -v -timeout 45m -race -p 1 ./api/hubd/... ./mongodb/...
  buckets-api:
    name: Buckets API
    runs-on: ubuntu-latest
    steps:
      - name: setup
        uses: actions/setup-go@v1
        with:
          go-version: 1.15
      - name: checkout
        uses: actions/checkout@v1
      - name: test
        env:
          STRIPE_API_KEY: ${{ secrets.STRIPE_API_KEY }}
        run: go test -v -timeout 45m -race -p 1 ./api/bucketsd/...
  users-api:
    name: Users API
    runs-on: ubuntu-latest
    steps:
      - name: setup
        uses: actions/setup-go@v1
        with:
          go-version: 1.15
      - name: checkout
        uses: actions/checkout@v1
      - name: test
        run: go test -v -timeout 45m -race -p 1 ./api/usersd/...
  billing-api:
    name: Billing API
    runs-on: ubuntu-latest
    steps:
      - name: setup
        uses: actions/setup-go@v1
        with:
          go-version: 1.15
      - name: checkout
        uses: actions/checkout@v1
      - name: test
        env:
          STRIPE_API_KEY: ${{ secrets.STRIPE_API_KEY }}
        run: go test -v -timeout 45m -race -p 1 ./api/billingd/...
  buckets:
    name: Buckets
    runs-on: self-hosted
    steps:
      - name: setup
        uses: actions/setup-go@v1
        with:
          go-version: 1.15
      - name: checkout
        uses: actions/checkout@v1
      - name: test
        run: go test -v -timeout 45m -race -p 1 ./buckets/...
  archives:
    name: Archives
    runs-on: self-hosted
    steps:
      - name: setup
        uses: actions/setup-go@v1
        with:
          go-version: 1.15
      - name: checkout
        uses: actions/checkout@v1
      - name: test
        run: go test -v -timeout 45m -race -p 1 ./integrationtest/...
  mail:
    name: Mail
    runs-on: self-hosted
    steps:
      - name: setup
        uses: actions/setup-go@v1
        with:
          go-version: 1.15
      - name: checkout
        uses: actions/checkout@v1
      - name: test
        run: go test -v -timeout 45m -race -p 1 ./mail/...